<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Archivos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-light: #93c5fd;
            --primary-dark: #1d4ed8;
            --primary-extra-light: #dbeafe;
            --primary-extra-dark: #1e3a8a;
            --text-dark: #1e293b;
            --text-light: #f8fafc;
            --bg-light: #f1f5f9;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .app-header {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .app-title {
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .card {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: var(--text-light);
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-bottom: none;
        }
        
        .card-body {
            padding: 1.5rem;
            background-color: var(--bg-white);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .btn {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-success:hover {
            background-color: var(--primary-extra-dark);
            border-color: var(--primary-extra-dark);
        }
        
        .btn-info {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
            color: var(--text-dark);
        }
        
        .btn-info:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: var(--text-light);
        }
        
        .btn-secondary {
            background-color: var(--text-dark);
            border-color: var(--text-dark);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            cursor: pointer;
        }
        
        .custom-file-input {
            border: 2px dashed var(--primary-light);
            border-radius: 12px;
            background-color: var(--primary-extra-light);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .custom-file-input:hover {
            border-color: var(--primary-color);
            background-color: #e6effe;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            font-size: 100px;
            opacity: 0;
            right: 0;
            top: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }
        
        .file-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .file-hint {
            color: var(--text-dark);
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }
        
        .folder-select-wrapper {
            position: relative;
        }
        
        .folder-select-wrapper::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--primary-color);
        }
        
        #folder-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 2.5rem;
        }
        
        .alert {
            border-radius: 8px;
            padding: 1rem;
        }
        
        .alert-success {
            background-color: var(--primary-extra-light);
            border-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .file-list-container {
            background-color: var(--bg-white);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
        }
        
        .actions-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .actions-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Nuevos estilos para la selección múltiple de archivos */
        .selected-files {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--primary-extra-light);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            background-color: var(--primary-light);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            overflow: hidden;
        }
        
        .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 8px;
        }
        
        .file-remove {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            padding: 0 8px;
            font-size: 1rem;
            transition: color 0.2s;
        }
        
        .file-remove:hover {
            color: #ef4444;
        }
        
        .upload-progress {
            height: 5px;
            border-radius: 3px;
            margin-top: 3px;
            background-color: var(--primary-extra-light);
            position: relative;
            overflow: hidden;
            display: none;
        }
        
        .upload-progress-bar {
            position: absolute;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s;
            width: 0;
        }
        
        .file-size {
            font-size: 0.75rem;
            color: var(--text-dark);
            opacity: 0.7;
            margin-left: 8px;
        }
        
        .drag-active {
            border-color: var(--primary-color);
            background-color: var(--primary-extra-light);
        }



        /* Estilos para animaciones y transiciones */
#file-list {
    transition: opacity 0.2s ease-in-out;
}

#current-path {
    transition: opacity 0.2s ease-in-out;
}

.loading-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px;
}

.file-item.folder {
    transition: background-color 0.15s ease-in-out;
}

.file-item.folder-clicked {
    background-color: #cfe2ff;
}

.btn-clicked {
    transform: scale(0.95);
    opacity: 0.9;
    transition: all 0.15s ease-in-out;
}

/* Mejora el efecto hover para las carpetas */
.file-item.folder:hover {
    background-color: #e2f0ff;
    transition: background-color 0.15s ease-in-out;
}

/* Animación para los items de la lista */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.file-item {
    animation: fadeIn 0.3s ease-out forwards;
    opacity: 0;
}

/* Aplicar retraso a los elementos para efecto escalonado */
.file-item:nth-child(1) { animation-delay: 0.05s; }
.file-item:nth-child(2) { animation-delay: 0.1s; }
.file-item:nth-child(3) { animation-delay: 0.15s; }
.file-item:nth-child(4) { animation-delay: 0.2s; }
.file-item:nth-child(5) { animation-delay: 0.25s; }
.file-item:nth-child(n+6) { animation-delay: 0.3s; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h1 class="app-title">Gestor de Archivos</h1>
        <p>Sube, organiza y administra tus archivos en el servidor</p>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cloud-upload-alt me-2"></i> Subir Archivos
                </div>
                <div class="card-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="files" class="form-label">Archivos</label>
                            <div class="file-input-wrapper">
                                <div class="custom-file-input" id="file-display">
                                    <i class="fas fa-file-upload file-icon"></i>
                                    <span id="file-name">Arrastra y suelta tus archivos aquí o haz clic para seleccionar</span>
                                    <span class="file-hint">Formatos soportados: todos los archivos</span>
                                </div>
                                <input type="file" class="form-control" id="files" name="files[]" multiple>
                            </div>
                        </div>
                        
                        <div id="selected-files" class="selected-files">
                            <!-- Los archivos seleccionados se mostrarán aquí -->
                        </div>
                        
                        <div class="mb-4 mt-4">
                            <label for="folder-select" class="form-label">Ubicación de los archivos</label>
                            <div class="folder-select-wrapper">
                                <select id="folder-select" class="form-control">
                                    <option value="">(Raíz)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="upload-button">
                            <i class="fas fa-upload me-2"></i> Subir Archivos
                        </button>
                    </form>
                    <div id="response" class="mt-3"></div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <i class="fas fa-server me-2"></i> Archivos en el Servidor
                    <span id="current-path" class="float-end text-muted">(Raíz)</span>
                </div>
                <div class="card-body">
                    <div id="file-list" class="file-list-container">
                        <p class="text-center text-muted">Haz clic en "Listar Archivos" para ver el contenido del servidor</p>
                    </div>
                    <div id="folder-navigation" class="mt-3 d-none">
                        <button id="go-back" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Volver
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-folder-plus me-2"></i> Crear Nueva Carpeta
                </div>
                <div class="card-body">
                    <form id="create-folder-form">
                        <div class="mb-3">
                            <label for="folder-name" class="form-label">Nombre de la carpeta</label>
                            <input type="text" class="form-control" id="folder-name" name="folder_name" placeholder="Ingresa el nombre de la carpeta" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-plus-circle me-2"></i> Crear Carpeta
                        </button>
                    </form>
                    <div id="folder-response" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog me-2"></i> Acciones
                </div>
                <div class="card-body">
                    <div class="actions-container">
                        <button id="test-ssh" class="btn btn-info w-100 mb-3">
                            <i class="fas fa-plug me-2"></i> Probar Conexión
                        </button>
                        <button id="list-files" class="btn btn-secondary w-100">
                            <i class="fas fa-list me-2"></i> Listar Archivos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    
    let currentFolder = ""; // Carpeta actual que estamos explorando
    let folderHistory = []; // Historial de navegación
    let isNavigating = false; // Bandera para evitar múltiples clics durante la navegación

    $(document).ready(function() {
        // Variables para controlar los archivos seleccionados
        var selectedFiles = [];
        
        // Función para formatear el tamaño del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Función para actualizar la vista de archivos seleccionados
        function updateSelectedFiles() {
            var $container = $('#selected-files');
            $container.empty();
            
            if (selectedFiles.length === 0) {
                $('#file-name').text('Arrastra y suelta tus archivos aquí o haz clic para seleccionar');
                $('#file-display').css('border-style', 'dashed');
                return;
            }
            
            $('#file-name').text(selectedFiles.length + ' archivos seleccionados');
            $('#file-display').css('border-style', 'solid');
            
            selectedFiles.forEach(function(file, index) {
                var fileIcon = getFileIcon(file.name);
                var $fileItem = $('<div class="file-item">' +
                    '<div class="file-info">' +
                        '<i class="' + fileIcon + '"></i>' +
                        '<span class="file-name">' + file.name + '</span>' +
                        '<span class="file-size">' + formatFileSize(file.size) + '</span>' +
                    '</div>' +
                    '<button type="button" class="file-remove" data-index="' + index + '">' +
                        '<i class="fas fa-times"></i>' +
                    '</button>' +
                    '<div class="upload-progress">' +
                        '<div class="upload-progress-bar"></div>' +
                    '</div>' +
                '</div>');
                
                $container.append($fileItem);
            });
            
            // Evento para eliminar archivos
            $('.file-remove').on('click', function() {
                var index = $(this).data('index');
                selectedFiles.splice(index, 1);
                updateSelectedFiles();
            });
        }
        
        // Función para determinar el icono según la extensión del archivo
        function getFileIcon(filename) {
            var ext = filename.split('.').pop().toLowerCase();
            
            switch(ext) {
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'doc':
                case 'docx':
                    return 'fas fa-file-word';
                case 'xls':
                case 'xlsx':
                    return 'fas fa-file-excel';
                case 'ppt':
                case 'pptx':
                    return 'fas fa-file-powerpoint';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                case 'bmp':
                    return 'fas fa-file-image';
                case 'zip':
                case 'rar':
                case '7z':
                    return 'fas fa-file-archive';
                case 'mp3':
                case 'wav':
                case 'ogg':
                    return 'fas fa-file-audio';
                case 'mp4':
                case 'avi':
                case 'mov':
                    return 'fas fa-file-video';
                case 'txt':
                    return 'fas fa-file-alt';
                case 'html':
                case 'css':
                case 'js':
                    return 'fas fa-file-code';
                default:
                    return 'fas fa-file';
            }
        }
        
        // Manejar la selección de archivos
        $('#files').on('change', function(e) {
            var files = e.target.files;
            if (files.length === 0) return;
            
            // Convertir FileList a array y agregar a los seleccionados
            for (var i = 0; i < files.length; i++) {
                selectedFiles.push(files[i]);
            }
            
            updateSelectedFiles();
        });
        
        // Soporte para arrastrar y soltar archivos
        var $dropZone = $('#file-display');
        
        $dropZone.on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('drag-active');
        });
        
        $dropZone.on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('drag-active');
        });
        
        $dropZone.on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('drag-active');
            
            var files = e.originalEvent.dataTransfer.files;
            if (files.length === 0) return;
            
            // Agregar archivos arrastrados a la lista
            for (var i = 0; i < files.length; i++) {
                selectedFiles.push(files[i]);
            }
            
            updateSelectedFiles();
        });

        loadFolders(); // Cargar carpetas al iniciar

        // Subir múltiples archivos con selección de carpeta
        $('#upload-form').on('submit', function(event) {
            event.preventDefault();
            
            if (selectedFiles.length === 0) {
                $('#response').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Por favor, selecciona al menos un archivo.</div>');
                return;
            }
            
            var formData = new FormData();
            var selectedFolder = $('#folder-select').val();
            formData.append("folder", selectedFolder);  // Agregar la carpeta seleccionada
            
            // Agregar todos los archivos seleccionados
            for (var i = 0; i < selectedFiles.length; i++) {
                formData.append("files[]", selectedFiles[i]);
            }
            
            $('#upload-button').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Subiendo...');
            $('.upload-progress').show();
            
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = (evt.loaded / evt.total) * 100;
                            $('.upload-progress-bar').width(percentComplete + '%');
                        }
                    }, false);
                    
                    return xhr;
                },
                beforeSend: function() {
                    $('#response').html('<div class="alert alert-info">Subiendo archivos, por favor espera...</div>');
                },
                success: function(response) {
                    var message = response.message;
                    
                    // Manejar la respuesta de carga parcial
                    if (response.partial) {
                        message += '<br><br><strong>Archivos subidos:</strong> ' + response.uploaded.join(', ');
                        message += '<br><strong>Archivos con error:</strong> ';
                        response.failed.forEach(function(item) {
                            message += '<br>' + item.filename + ' - ' + item.error;
                        });
                    }
                    
                    $('#response').html('<div class="alert alert-' + (response.success ? 'success' : 'danger') + '">' + 
                        '<i class="fas fa-' + (response.success ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' +
                        message + '</div>');
                    
                    if (response.success) {
                        // Reiniciar el formulario
                        $('#upload-form')[0].reset();
                        selectedFiles = [];
                        updateSelectedFiles();
                    }
                    
                    $('#upload-button').prop('disabled', false).html('<i class="fas fa-upload me-2"></i> Subir Archivos');
                    $('.upload-progress').hide();
                },
                error: function() {
                    $('#response').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al subir archivos. Intenta de nuevo.</div>');
                    $('#upload-button').prop('disabled', false).html('<i class="fas fa-upload me-2"></i> Subir Archivos');
                    $('.upload-progress').hide();
                }
            });
        });

        // Crear carpeta en el servidor
        $('#create-folder-form').on('submit', function(event) {
            event.preventDefault();
            
            var folderName = $('#folder-name').val().trim();
            if (folderName === "") {
                $('#folder-response').html('<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>El nombre de la carpeta no puede estar vacío.</div>');
                return;
            }

            $.ajax({
                url: '/create-folder',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ folder_name: folderName }),
                beforeSend: function() {
                    $('#folder-response').html('<div class="alert alert-info">Creando carpeta, por favor espera...</div>');
                },
                success: function(response) {
                    $('#folder-response').html('<div class="alert alert-' + (response.success ? 'success' : 'danger') + '">' + 
                        '<i class="fas fa-' + (response.success ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' +
                        response.message + '</div>');
                    
                    if (response.success) {
                        loadFolders(); // Recargar la lista de carpetas si se creó correctamente
                        $('#create-folder-form')[0].reset(); // Limpiar formulario
                    }
                },
                error: function() {
                    $('#folder-response').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al crear la carpeta. Intenta de nuevo.</div>');
                }
            });
        });

        // Probar conexión SSH
        $('#test-ssh').on('click', function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Probando...');
            
            $.get('/test-ssh', function(response) {
                $('#response').html('<div class="alert alert-' + (response.success ? 'success' : 'danger') + '">' + 
                    '<i class="fas fa-' + (response.success ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' +
                    response.message + (response.success ? '<br>' + response.output : '') + '</div>');
                
                $('#test-ssh').prop('disabled', false).html('<i class="fas fa-plug me-2"></i> Probar Conexión');
            }).fail(function() {
                $('#response').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al probar la conexión. Intenta de nuevo.</div>');
                $('#test-ssh').prop('disabled', false).html('<i class="fas fa-plug me-2"></i> Probar Conexión');
            });
        });

        // Listar archivos en el servidor
        $('#list-files').on('click', function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Cargando...');
            
            $.get('/list-files', function(response) {
                if (response.success) {
                    $('#file-list').html('<pre>' + response.output + '</pre>');
                } else {
                    $('#file-list').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>' + response.message + '</div>');
                }
                
                $('#list-files').prop('disabled', false).html('<i class="fas fa-list me-2"></i> Listar Archivos');
            }).fail(function() {
                $('#file-list').html('<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error al listar archivos. Intenta de nuevo.</div>');
                $('#list-files').prop('disabled', false).html('<i class="fas fa-list me-2"></i> Listar Archivos');
            });
        });
    });


    function listFilesInFolder(folder) {
        $.ajax({
            url: '/list-files',
            type: 'GET',
            data: { folder: folder },
            success: function(response) {
                if (response.success) {
                    var files = response.files;
                    var fileListContainer = $('#file-list');
                    fileListContainer.empty();  // Limpiar los archivos anteriores
    
                    files.forEach(function(file) {
                        var fileElement = $('<div class="file-item"></div>');
                        
                        // Verifica si es un archivo o carpeta
                        if (file.is_directory) {
                            fileElement.append('<span class="folder-name">' + file.filename + '</span>');
                        } else {
                            var fileExtension = file.filename.split('.').pop().toLowerCase();
                            
                            // Mostrar una vista previa para imágenes
                            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                                // Mostrar una vista previa de la imagen
                                fileElement.append('<img src="/uploads/' + folder + '/' + file.filename + '" class="file-thumbnail" alt="Imagen">');
                            }
                            // Mostrar enlace para PDFs
                            else if (fileExtension === 'pdf') {
                                fileElement.append('<a href="/uploads/' + folder + '/' + file.filename + '" target="_blank">Ver PDF</a>');
                            }
                            // Para otros archivos
                            else {
                                fileElement.append('<span class="file-name">' + file.filename + '</span>');
                            }
                        }
    
                        fileListContainer.append(fileElement);
                    });
                } else {
                    $('#file-list').html('<p class="text-danger">Error al listar archivos: ' + response.message + '</p>');
                }
            },
            error: function() {
                $('#file-list').html('<p class="text-danger">Hubo un problema al intentar listar los archivos.</p>');
            }
        });
    }
    
    // Llamar a la función para listar los archivos en la carpeta deseada
    $('#folder-select').change(function() {
        var selectedFolder = $(this).val();
        listFilesInFolder(selectedFolder);
    });


    // Cargar lista de carpetas
    function loadFolders() {
        $.get('/list-folders', function(response) {
            if (response.success) {
                var folderSelect = $('#folder-select');
                folderSelect.empty();
                folderSelect.append('<option value="">(Raíz)</option>');
                response.folders.forEach(function(folder) {
                    folderSelect.append('<option value="' + folder + '">' + folder + '</option>');
                });
            }
        });
    }
    

// Función para listar el contenido de una carpeta con animación fluida
function listFolderContent(folder = "") {
    // Evitar navegación múltiple si ya está cargando
    if (isNavigating) return;
    isNavigating = true;
    
    // Mostrar indicador de carga
    const fileListDiv = document.getElementById('file-list');
    fileListDiv.innerHTML = `
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status"></div>
            <span class="ms-2">Cargando contenido...</span>
        </div>
    `;
    
    // Construir la URL con el parámetro de la carpeta
    const url = `/list-folder-content${folder ? `?folder=${encodeURIComponent(folder)}` : ''}`;
    
    // Añadir una pequeña demora para que se vea la animación (opcional)
    setTimeout(() => {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const currentPathSpan = document.getElementById('current-path');
                const folderNavigation = document.getElementById('folder-navigation');
                
                // Actualizar la ruta actual mostrada con animación
                currentPathSpan.style.opacity = "0";
                setTimeout(() => {
                    currentPathSpan.textContent = folder ? folder : '(Raíz)';
                    currentPathSpan.style.opacity = "1";
                }, 200);
                
                // Mostrar u ocultar el botón de volver según corresponda
                if (folderHistory.length > 0) {
                    folderNavigation.classList.remove('d-none');
                } else {
                    folderNavigation.classList.add('d-none');
                }
                
                // Preparar el nuevo contenido
                let html = '';
                
                if (data.success) {
                    html = '<ul class="file-list">';
                    
                    // Primero mostrar las carpetas
                    if (data.folders && data.folders.length > 0) {
                        data.folders.forEach(item => {
                            const folderDate = new Date(item.modified * 1000).toLocaleString();
                            html += `
                                <li class="file-item folder">
                                    <div class="file-info">
                                        <i class="fas fa-folder me-2"></i>
                                        <span class="file-name" data-folder="${item.name}">${item.name}</span>
                                    </div>
                                    <div class="file-meta">
                                        <span class="file-date">${folderDate}</span>
                                    </div>
                                </li>
                            `;
                        });
                    }
                    
                    // Luego mostrar los archivos
                    if (data.files && data.files.length > 0) {
                        data.files.forEach(item => {
                            const fileDate = new Date(item.modified * 1000).toLocaleString();
                            const fileSize = formatFileSize(item.size);
                            html += `
                                <li class="file-item">
                                    <div class="file-info">
                                        <i class="fas fa-file me-2"></i>
                                        <span class="file-name">${item.name}</span>
                                    </div>
                                    <div class="file-meta">
                                        <span class="file-size">${fileSize}</span>
                                        <span class="file-date">${fileDate}</span>
                                    </div>
                                </li>
                            `;
                        });
                    }
                    
                    // Si no hay archivos ni carpetas
                    if ((!data.folders || data.folders.length === 0) && (!data.files || data.files.length === 0)) {
                        html += '<li class="empty-folder"><i class="fas fa-folder-open me-2"></i> Esta carpeta está vacía</li>';
                    }
                    
                    html += '</ul>';
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> ${data.message}
                        </div>
                    `;
                }
                
                // Agregar el contenido con animación fade
                fileListDiv.style.opacity = "0";
                setTimeout(() => {
                    fileListDiv.innerHTML = html;
                    fileListDiv.style.opacity = "1";
                    
                    // Agregar eventos click a las carpetas para navegación
                    const folderElements = fileListDiv.querySelectorAll('.file-item.folder .file-name');
                    folderElements.forEach(folder => {
                        folder.addEventListener('click', function() {
                            // Efecto visual de clic
                            this.closest('.file-item').classList.add('folder-clicked');
                            
                            const folderName = this.getAttribute('data-folder');
                            setTimeout(() => {
                                navigateToFolder(folderName);
                            }, 150); // Pequeña demora para ver el efecto
                        });
                    });
                    
                    // Navegación completada
                    isNavigating = false;
                }, 200);
            })
            .catch(error => {
                console.error('Error:', error);
                fileListDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i> Error de conexión: ${error.message}
                    </div>
                `;
                isNavigating = false;
            });
    }, 200);
}

// Función para navegar a una carpeta
function navigateToFolder(folderName) {
    // Guardar la carpeta actual en el historial
    folderHistory.push(currentFolder);
    
    // Construir la nueva ruta
    currentFolder = currentFolder ? `${currentFolder}/${folderName}` : folderName;
    
    // Listar el contenido de la nueva carpeta
    listFolderContent(currentFolder);
}

// Función para volver a la carpeta anterior con animación
document.getElementById('go-back').addEventListener('click', function() {
    if (folderHistory.length > 0 && !isNavigating) {
        // Efecto visual en el botón
        this.classList.add('btn-clicked');
        
        setTimeout(() => {
            this.classList.remove('btn-clicked');
            // Recuperar la última carpeta del historial
            currentFolder = folderHistory.pop();
            
            // Listar el contenido de la carpeta anterior
            listFolderContent(currentFolder);
        }, 150);
    }
});

// Evento para listar archivos con animación
document.getElementById('list-files').addEventListener('click', function() {
    if (isNavigating) return;
    
    // Efecto visual en el botón
    this.classList.add('btn-clicked');
    
    setTimeout(() => {
        this.classList.remove('btn-clicked');
        // Reiniciar la navegación
        currentFolder = "";
        folderHistory = [];
        
        // Listar el contenido de la carpeta raíz
        listFolderContent();
    }, 150);
});

// Utilidad para formatear el tamaño de archivos
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

</script>

</body>
</html>